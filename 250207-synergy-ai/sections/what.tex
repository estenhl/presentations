\section{How can we find new phenotypes with AI?}

\newcommand{\mriside}[5]{

    \node[inner sep=0pt] (input) at (#1, #2) {
        \includegraphics[height=#3, width=#3]{#4}
    };

    \draw[fill=black] (input.north west) --
        ($ (input.north west) + (0.5 * #5, 0.5 * #5) $) --
        ($ (input.north east) + (0.5 * #5, 0.5 * #5) $) --
        (input.north east) -- cycle;
    \draw[fill=black] (input.north east) --
        ($ (input.north east) + (0.5 * #5, 0.5 * #5) $) --
        ($ (input.south east) + (0.5 * #5, 0.5 * #5) $) --
        (input.south east) -- cycle;
    \draw[] (input.north west) --
        ($ (input.north west) - (0.5 * #5, 0.5 * #5) $) --
        ($ (input.south west) - (0.5 * #5, 0.5 * #5) $) --
        (input.south west) -- cycle;
    \draw[] (input.north east) --
        ($ (input.north east) - (0.5 * #5, 0.5 * #5) $) --
        ($ (input.south east) - (0.5 * #5, 0.5 * #5) $) --
        (input.south east) -- cycle;
    \draw[] ($ (input.north west) - (0.5 * #5, 0.5 * #5) $) --
        ($ (input.north east) - (0.5 * #5, 0.5 * #5) $);
    \draw[] ($ (input.south west) - (0.5 * #5, 0.5 * #5) $) --
        ($ (input.south east) - (0.5 * #5, 0.5 * #5) $);
}


\newcommand{\inputside}[4]{
    \mriside{#1}{#2}{#3}{data/mri_sagittal.png}{#4}
}

\newcommand{\convside}[6]{
    \def\sidex{#1}
    \def\sidey{#2}
    \def\sidewidth{#3}
    \def\sideheight{#4}
    \def\sidefillcolour{#5}
    \def\sidename{#6}

    \node[
        fill=\sidefillcolour,
        inner sep=0pt,
        outer sep=0pt,
        minimum width=\sidewidth,
        minimum height=\sideheight,
        draw=black
    ] (\sidename) at (\sidex, \sidey) {};
}

\newcommand{\convtop}[4]{
    \def\topbase{#1}
    \def\topwidth{#2}
    \def\topheight{#3}
    \def\topfillcolour{#4}

    \draw[fill=\topfillcolour,draw=black] #1 --
        ($ #1 + (#3, #3) $) --
        ($ #1 + (#3+#2, #3) $) --
        ($ #1 + (#2, 0) $);
}

\newcommand{\convfront}[3]{
    \def\frontbase{#1}
    \def\frontsize{#2}
    \def\frontfillcolour{#3}

    \draw[black, fill=\frontfillcolour] #1 --
        ($ #1 + (1*#2, 1*#2) $) --
        ($ #1 + (1*#2, 1*#2 - 2*#2) $) --
        ($ #1 + (0, -2*#2) $);
}

\newcommand{\convchannel}[7]{
    \def\channelx{#1}
    \def\channely{#2}
    \def\channelnodedepth{#3}
    \def\channelnodesize{#4}
    \def\channelnodecount{#5}
    \def\channelcolour{#6}
    \def\includefront{#7}

    \def\huemin{20}
    \def\huemax{80}

    \pgfmathsetmacro{\iterations}{#5-1}
    \foreach \i in {0,...,\iterations} {
        \pgfmathsetmacro{\hue}{int(random(\huemin, \huemax))}
        \convside{#1}{#2+\i*-#4}{#3 cm}{#4 cm}{#6!\hue}{n\i0}

        \foreach \j in {0,...,\iterations} {
            \pgfmathsetmacro{\innerhue}{int(random(\huemin, \huemax))}
            \ifnum\j=0
                \pgfmathsetmacro{\innerhue}{\hue}
            \fi

            \ifnum\includefront=1
                \convfront{($ (n00.north east) + (0.5*\j*#4, 0.5*\j*#4 - \i*#4) $)}{0.5*#4}{#6!\innerhue}
            \fi

            \ifnum\i=0
                \convtop{($ (n\i0.north west) + (0.5*\j*#4, 0.5*\j*#4) $)}{#3}{0.5*#4}{#6!\innerhue}
            \fi
        }
    }
}
\newcommand{\convlayer}[7]{
    \def\layerx{#1}
    \def\layery{#2}
    \def\layernodedepth{#3}
    \def\layernodesize{#4}
    \def\layernodecount{#5}
    \def\layerdepth{#6}
    \def\layercolour{#7}

    \pgfmathsetmacro{\layeriterations}{\layerdepth-1}
    \foreach \i in {0,...,\layeriterations}{
        \pgfmathsetmacro{\x}{\layerx + \i * \layernodedepth}
        \pgfmathsetmacro{\islast}{\i == \layeriterations ? 1 : 0}
        \convchannel{\x}{\layery}{\layernodedepth}{\layernodesize}{\layernodecount}{\layercolour}{\islast}
    }
}

\newcommand{\modelarrow}[5]{
    \begin{scope}[transparency group, opacity=0.5]
        \draw[-stealth, line width=2pt, #3] #1 to [in=#4, out=#5] #2;
    \end{scope}
}

\newcommand{\cnnarrow}[3]{
    \modelarrow{#1}{#2}{#3}{180}{0}
}

\newcommand{\cnn}[6]{
    \def\xmin{#1}
    \def\ymin{#2}
    \def\nodedepth{#3}
    \def\nodesize{#4}
    \def\modelcolour{#5}
    \def\annotate{#6}

    \convlayer{#1 - 0.06 + 0.4}{#2 + 2.5 * #4}{#3}{#4}{12}{3}{\modelcolour}
    \cnnarrow{(#1 + 0.95, #2)}{(#1+2.2, #2)}{#5}

    \convlayer{#1 + 1.44 + 0.4}{#2 + 1.5 * #4}{#3}{#4}{8}{5}{\modelcolour}
    \cnnarrow{(#1 + 2.43, #2)}{(#1+3.5, #2)}{#5}

    \convlayer{#1 + 2.77 + 0.4}{#2 + 0.5 * #4}{#3}{#4}{4}{7}{\modelcolour}
    \cnnarrow{(#1 + 3.75, #2)}{(#1+5, #2)}{#5}

    \convlayer{#1 + 3.93 + 0.4}{#2 + 0}{#3}{#4}{2}{9}{\modelcolour}

    \draw[thick, dashed] (#1 + 0.22, #2 + 1.43) --
                        (#1 + 5.13, #2 + 1.43) --
                        (#1 + 5.13, #2 - 1.42) --
                        (#1 + 0.22, #2 - 1.42) -- cycle;
    \node[anchor=south, text depth=0] at (#1 + 2.675, #2 + 1.43) {
        \textbf{#6}
    };
}

\newcommand{\featurespace}[1]{
    \begin{tikzpicture}
        \begin{axis}[
            height=2.7cm,
            width=2.7cm,
            xmajorticks=false,
            ymajorticks=false
        ]
        \addplot[
            only marks,
            mark=*,
            mark options={
                draw=black,
                fill=white,
                scale=0.75
            },
            opacity=0.5,
            discard if not={label}{0}
        ] table [
            col sep=comma,
            x=x,
            y=y
        ] {#1};
        \addplot[
            only marks,
            mark=*,
            mark options={
                draw=black,
                fill=red,
                scale=0.75
            },
            opacity=0.5,
            discard if not={label}{1}
        ] table [
            col sep=comma,
            x=x,
            y=y
        ] {#1};
        \end{axis}
    \end{tikzpicture}
}

\newsavebox{\inputspace}
\sbox{\inputspace}{
    \featurespace{data/input_space.csv}
}
\newsavebox{\firstfeaturespace}
\sbox{\firstfeaturespace}{
    \featurespace{data/first_feature_space.csv}
}
\newsavebox{\secondfeaturespace}
\sbox{\secondfeaturespace}{
    \featurespace{data/second_feature_space.csv}
}
\newsavebox{\thirdfeaturespace}
\sbox{\thirdfeaturespace}{
    \featurespace{data/third_feature_space.csv}
}

\begin{frame}{What does neural networks do?}
    \begin{tikzpicture}
        \node[draw=black] at (-5.25, -3.25) {};
        \node[draw=black] at (5.25, 3.25) {};

        \visible<3-5>{
            \inputside{-3.95}{0}{1.5cm}{0.75}
            \cnnarrow{(input.east)}{($ (input.center) + (2, 0) $)}{blue}
            \node[draw=black, minimum height=2.8cm, minimum width=0.1cm, top color=red, bottom color=white, inner sep=0pt] (scale) at (3.5, 0) {};
            \cnnarrow{(2.41, 0)}{(scale.west)}{blue}
            \node[anchor=west, font=\footnotesize] at (scale.north east) {
                1
            };
            \node[anchor=west, font=\footnotesize] at (scale.south east) {
                0
            };
        }
        \visible<3>{
            \node[circle, minimum size=0.18cm, inner sep=0pt, draw=black, fill=white, label=right:\textbf{\footnotesize{0.40}}] at ($ (scale) - (0, 0.28) $) {};
        }
        \visible<4>{
            \node[circle, minimum size=0.18cm, inner sep=0pt, draw=black, fill=white] at ($ (scale) - (0, 0.28) $) {};
            \node[circle, minimum size=0.18cm, inner sep=0pt, draw=black, fill=white] at ($ (scale) - (0, 1.2) $) {};
            \node[circle, minimum size=0.18cm, inner sep=0pt, draw=black, fill=white] at ($ (scale) - (0, 1.0) $) {};
            \node[circle, minimum size=0.18cm, inner sep=0pt, draw=black, fill=white] at ($ (scale) - (0, 0.9) $) {};
            \node[circle, minimum size=0.18cm, inner sep=0pt, draw=black, fill=white] at ($ (scale) - (0, 0.7) $) {};
            \node[circle, minimum size=0.18cm, inner sep=0pt, draw=black, fill=white] at ($ (scale) + (0, 0.14) $) {};
            \node[circle, minimum size=0.18cm, inner sep=0pt, draw=black, fill=white] at ($ (scale) + (0, 0.3) $) {};
            \node[circle, minimum size=0.18cm, inner sep=0pt, draw=black, fill=white] at ($ (scale) + (0, 0.7) $) {};
            \node[circle, minimum size=0.18cm, inner sep=0pt, draw=black, fill=white] at ($ (scale) + (0, 0.95) $) {};
            \node[circle, minimum size=0.18cm, inner sep=0pt, draw=black, fill=white] at ($ (scale) + (0, 1.35) $) {};
        }
        \visible<5>{
            \node[circle, minimum size=0.18cm, inner sep=0pt, draw=black, fill=white] at ($ (scale) - (0, 1.2) $) {};
            \node[circle, minimum size=0.18cm, inner sep=0pt, draw=black, fill=red] at ($ (scale) - (0, 1.0) $) {};
            \node[circle, minimum size=0.18cm, inner sep=0pt, draw=black, fill=white] at ($ (scale) - (0, 0.9) $) {};
            \node[circle, minimum size=0.18cm, inner sep=0pt, draw=black, fill=white] at ($ (scale) - (0, 0.7) $) {};
            \node[circle, minimum size=0.18cm, inner sep=0pt, draw=black, fill=red] at ($ (scale) - (0, 0.28) $) {};
            \node[circle, minimum size=0.18cm, inner sep=0pt, draw=black, fill=red] at ($ (scale) + (0, 0.14) $) {};
            \node[circle, minimum size=0.18cm, inner sep=0pt, draw=black, fill=white] at ($ (scale) + (0, 0.3) $) {};
            \node[circle, minimum size=0.18cm, inner sep=0pt, draw=black, fill=red] at ($ (scale) + (0, 0.7) $) {};
            \node[circle, minimum size=0.18cm, inner sep=0pt, draw=black, fill=red] at ($ (scale) + (0, 0.95) $) {};
            \node[circle, minimum size=0.18cm, inner sep=0pt, draw=black, fill=red] at ($ (scale) + (0, 1.35) $) {};


            \node[circle, minimum size=0.18cm, inner sep=0pt, draw=black, fill=red, label=right:\footnotesize{Cases}] at ($ (scale) - (0.6, 1.7) $) {};
            \node[circle, minimum size=0.18cm, inner sep=0pt, draw=black, fill=white, label=right:\footnotesize{Controls}] at ($ (scale) - (0.6, 1.95) $) {};
        }


        \visible<1>{
            \cnn{-2.55}{0}{0.066}{0.15}{blue}{Convolutional neural network}
        }
        \visible<2-5>{
            \cnn{-2.55}{0}{0.066}{0.15}{blue}{Trained case-control classifier}
        }

        \visible<6-8>{
            \def\spacing{-0.1cm}
            \node[align=left, font=\tiny] at (0, 0) {
                \begin{math}
                    \begin{alignedat}{5}
                        \hat{y} &= \max(0, &&0.45*\max(0, &&0.67*\max(0, 0.12*x_0+0.34*x_{1}+0.56*x_{2}+0.78*x_{3}+0.91)+\\[\spacing]
                        & && &&0.23*\max(0, 0.11*x_0+0.22*x_{1}+0.33*x_{2}+0.44*x_{3}+0.55)+\\[\spacing]
                        & && &&0.89*\max(0, 0.66*x_0+0.77*x_{1}+0.88*x_{2}+0.99*x_{3}+0.10)+\\[\spacing]
                        & && &&0.21)+\\[\spacing]
                        & &&0.54*\max(0, &&0.76*\max(0, 0.12*x_0+0.34*x_{1}+0.56*x_{2}+0.78*x_{3}+0.91)+\\[\spacing]
                        & && &&0.65*\max(0, 0.11*x_0+0.22*x_{1}+0.33*x_{2}+0.44*x_{3}+0.55)+\\[\spacing]
                        & && &&0.43*\max(0, 0.66*x_0+0.77*x_{1}+0.88*x_{2}+0.99*x_{3}+0.10)+\\[\spacing]
                        & && &&0.32)+\\[\spacing]
                        & &&0.98*\max(0, &&0.87*\max(0, 0.12*x_0+0.34*x_{1}+0.56*x_{2}+0.78*x_{3}+0.91)+\\[\spacing]
                        & && &&0.76*\max(0, 0.11*x_0+0.22*x_{1}+0.33*x_{2}+0.44*x_{3}+0.55)+\\[\spacing]
                        & && &&0.65*\max(0, 0.66*x_0+0.77*x_{1}+0.88*x_{2}+0.99*x_{3}+0.10)+\\[\spacing]
                        & && &&0.54)+\\[\spacing]
                        & &&0.31*\max(0, &&0.21*\max(0, 0.12*x_0+0.34*x_{1}+0.56*x_{2}+0.78*x_{3}+0.91)+\\[\spacing]
                        & && &&0.32*\max(0, 0.11*x_0+0.22*x_{1}+0.33*x_{2}+0.44*x_{3}+0.55)+\\[\spacing]
                        & && &&0.43*\max(0, 0.66*x_0+0.77*x_{1}+0.88*x_{2}+0.99*x_{3}+0.10)+\\[\spacing]
                        & && &&0.65)+\\[\spacing]
                        & &&0.06*\max(0, &&0.27*\max(0, 0.12*x_0+0.34*x_{1}+0.56*x_{2}+0.78*x_{3}+0.91)+\\[\spacing]
                        & && &&0.85*\max(0, 0.11*x_0+0.22*x_{1}+0.33*x_{2}+0.44*x_{3}+0.55)+\\[\spacing]
                        & && &&0.17*\max(0, 0.66*x_0+0.77*x_{1}+0.88*x_{2}+0.99*x_{3}+0.10)+\\[\spacing]
                        & && &&0.42)+\\[\spacing]
                        & &&0.76)&&\\
                    \end{alignedat}
                \end{math}

            };
        }
        \visible<7-8>{
            \node[minimum height=0.12cm, minimum width=6cm, draw=red, thick] at (1.04, -0.99) {};
        }
        \visible<8>{
            \node[minimum height=0.12cm, minimum width=0.4cm, draw=red, thick] at (-2.95, -0.49) {};
            \node[minimum height=0.12cm, minimum width=0.4cm, draw=red, thick] at (-2.95, -2.47) {};
        }
        \visible<9->{
            \inputside{-3.3}{2.25}{0.75cm}{0.375}
            \inputside{-3.3}{-0.25}{0.75cm}{0.375}
            \inputside{-4.55}{1}{0.75cm}{0.375}
            \inputside{-4.55}{2.25}{0.75cm}{0.375}
            \inputside{-4.55}{-0.25}{0.75cm}{0.375}
            \inputside{-3.3}{1}{0.75cm}{0.375}

            \def\xmin{-2.55}
            \def\ymin{1}
            \def\nodedepth{0.066}
            \def\nodesize{0.15}

            \draw[thick, dashed] (\xmin + 0.22, \ymin + 1.43) --
                                (\xmin + 5.13, \ymin + 1.43) --
                                (\xmin + 5.13, \ymin - 1.42) --
                                (\xmin + 0.22, \ymin - 1.42) -- cycle;
        }
        \visible<10->{
            \node[] (inputspace) at (-4, -2) {
                \usebox{\inputspace}
            };
            \node[circle, minimum size=0.1cm, inner sep=0pt, draw=black, fill=white, label=right:\footnotesize{Controls}] at ($ (inputspace.south east) + (-0.15, 0.3) $) {};
            \node[circle, minimum size=0.1cm, inner sep=0pt, draw=black, fill=red, label=right:\footnotesize{Cases}] at ($ (inputspace.south east) + (-0.15, 0.54) $) {};
        }
        \visible<11->{
            \node[anchor=north, draw=black, fill=black!60, inner sep=3pt] at ($ (inputspace.south) + (0, 0.07) $) {};
            \node[anchor=east, draw=black, fill=black!60, inner sep=3pt] at ($ (inputspace.west) + (0.25, 0) $) {};
        }
        \visible<9-11>{
            \convlayer{\xmin - 0.06 + 0.4}{\ymin + 2.5 * \nodesize}{\nodedepth}{\nodesize}{12}{3}{gray}
        }
        \visible<12->{
            \cnnarrow{(input.east)}{($ (input.center) + (2, 0) $)}{blue}
            \convlayer{\xmin - 0.06 + 0.4}{\ymin + 2.5 * \nodesize}{\nodedepth}{\nodesize}{12}{3}{blue}

            \node[] (firstfeatures) at (-0.95, -2) {
                \usebox{\firstfeaturespace}
            };
        }
        \visible<9-12>{
            \cnnarrow{(\xmin + 0.95, \ymin)}{(\xmin+2.2, \ymin)}{gray}
            \convlayer{\xmin + 1.44 + 0.4}{\ymin + 1.5 * \nodesize}{\nodedepth}{\nodesize}{8}{5}{gray}
        }
        \visible<13->{
            \cnnarrow{(\xmin + 0.95, \ymin)}{(\xmin+2.2, \ymin)}{blue}
            \convlayer{\xmin + 1.44 + 0.4}{\ymin + 1.5 * \nodesize}{\nodedepth}{\nodesize}{8}{5}{blue}

            \node[] (secondfeatures) at (0.38, -2) {
                \usebox{\secondfeaturespace}
            };
        }
        \visible<9-13>{
            \cnnarrow{(\xmin + 2.43, \ymin)}{(\xmin+3.5, \ymin)}{gray}
            \convlayer{\xmin + 2.77 + 0.4}{\ymin + 0.5 * \nodesize}{\nodedepth}{\nodesize}{4}{7}{gray}
        }
        \visible<14->{
            \cnnarrow{(\xmin + 2.43, \ymin)}{(\xmin+3.5, \ymin)}{blue}
            \convlayer{\xmin + 2.77 + 0.4}{\ymin + 0.5 * \nodesize}{\nodedepth}{\nodesize}{4}{7}{blue}

            \node[] (thirdfeatures) at (1.56, -2) {
                \usebox{\thirdfeaturespace}
            };
        }
        \visible<9-14>{
            \cnnarrow{(\xmin + 3.75, \ymin)}{(\xmin+5, \ymin)}{gray}
            \convlayer{\xmin + 3.93 + 0.4}{\ymin + 0}{\nodedepth}{\nodesize}{2}{9}{gray}
        }
        \visible<15->{
            \cnnarrow{(\xmin + 3.75, \ymin)}{(\xmin+5, \ymin)}{blue}
            \convlayer{\xmin + 3.93 + 0.4}{\ymin + 0}{\nodedepth}{\nodesize}{2}{9}{blue}

            \node[draw=black, minimum height=2.8cm, minimum width=0.1cm, top color=red, bottom color=white, inner sep=0pt] (scale) at (3.5, 1) {};
            \cnnarrow{(2.41, 1)}{(scale.west)}{blue}
            \node[anchor=west, font=\footnotesize] at (scale.north east) {
                1
            };
            \node[anchor=west, font=\footnotesize] at (scale.south east) {
                0
            };

            \node[circle, minimum size=0.18cm, inner sep=0pt, draw=black, fill=white] at ($ (scale) - (0, 1.2) $) {};
            \node[circle, minimum size=0.18cm, inner sep=0pt, draw=black, fill=red] at ($ (scale) - (0, 1.0) $) {};
            \node[circle, minimum size=0.18cm, inner sep=0pt, draw=black, fill=white] at ($ (scale) - (0, 0.9) $) {};
            \node[circle, minimum size=0.18cm, inner sep=0pt, draw=black, fill=white] at ($ (scale) - (0, 0.7) $) {};
            \node[circle, minimum size=0.18cm, inner sep=0pt, draw=black, fill=red] at ($ (scale) - (0, 0.28) $) {};
            \node[circle, minimum size=0.18cm, inner sep=0pt, draw=black, fill=red] at ($ (scale) + (0, 0.14) $) {};
            \node[circle, minimum size=0.18cm, inner sep=0pt, draw=black, fill=white] at ($ (scale) + (0, 0.3) $) {};
            \node[circle, minimum size=0.18cm, inner sep=0pt, draw=black, fill=red] at ($ (scale) + (0, 0.7) $) {};
            \node[circle, minimum size=0.18cm, inner sep=0pt, draw=black, fill=red] at ($ (scale) + (0, 0.95) $) {};
            \node[circle, minimum size=0.18cm, inner sep=0pt, draw=black, fill=red] at ($ (scale) + (0, 1.35) $) {};

            \node[circle, minimum size=0.18cm, inner sep=0pt, draw=black, fill=red, label=right:\footnotesize{Cases}] at ($ (scale) - (0.6, 1.7) $) {};
            \node[circle, minimum size=0.18cm, inner sep=0pt, draw=black, fill=white, label=right:\footnotesize{Controls}] at ($ (scale) - (0.6, 1.95) $) {};
        }
        \visible<16>{
            \node[draw=red, thick, densely dotted, minimum height=1.5cm, minimum width=4.02cm, label=below:\textbf{\footnotesize{\textcolor{red}{Feature spaces}}}] at ($ (secondfeatures) - (0.07, 0) $) {};
        }
        \visible<20>{
            \draw[-stealth, line width=4pt] ($ (firstfeatures.north west) - (-0.1, -0.3) $) -- ($ (thirdfeatures.north east) - (0.1, -0.3) $);
        }
        \visible<21>{
            \draw[-stealth, very thick] ($ (thirdfeatures) + (-0.4, -0.3) $) -- ($ (thirdfeatures) + (0.4, 0.3) $) node[midway, above, font=\scriptsize\bfseries, rotate=37, yshift=-0.1cm] {MMSE};
        }
    \end{tikzpicture}
\end{frame}
