\newsavebox{\validationbox}
\sbox{\validationbox}{
    \begin{tikzpicture}
        \begin{axis}[
            width=0.85\textwidth,
            height=0.65\textwidth,
            xmin=0,
            xmax=100,
            ytick=\empty,
            axis x line=middle,
            axis y line=none,
            xtick={10,20,30,40,50,60,70,80,90},
            xticklabels={10,20,30,40,50,60,70,80,{}},
            x axis line style={|-stealth},
            clip=false,
            axis on top,
            tick label style={font=\footnotesize}
        ]
            \pgfplotstableread[col sep=comma]{data/validation.csv}\datatable


            \addplot[
                name path=zero,
            ] coordinates {(0,0) (100,0)};

            \pgfplotsinvokeforeach{ABCD, QTAB, PING, PNC, ds000119, SLIM, QTIM, Beijing, AOMIC-PIOP2, ds000202, AOMIC-PIOP1, AOMIC-ID1000, CoRR, HCP, FCON1000, NIMH, NKI-RS, MPI-LEMON, ds003592, ds000222, SALD, IXI, DLBS, Cam-CAN, UKBB, ADNI}{
                \begingroup
                    \addplot [
                        draw=none,
                        line width=0pt,
                        name path=female_#1,
                    ] table [
                        x=age,
                        y expr=1*\thisrow{female_#1}
                    ] {\datatable};

                    \addplot [
                        draw=none,
                        line width=0pt,
                        name path=male_#1,
                    ] table [
                        x=age,
                        y expr=-1*\thisrow{male_#1}
                    ] {\datatable};
                \endgroup
            }
            \pgfplotsinvokeforeach{male, female}{
                \addplot[fill=ABCD!50] fill between[of=zero and #1_ABCD];
                \addplot[fill=QTAB!50] fill between[of=#1_ABCD and #1_QTAB];
                \addplot[fill=PING!50] fill between[of=#1_QTAB and #1_PING];
                \addplot[fill=PNC!50] fill between[of=#1_PING and #1_PNC];
                \addplot[fill=ds000119!50] fill between[of=#1_PNC and #1_ds000119];
                \addplot[fill=SLIM!50] fill between[of=#1_ds000119 and #1_SLIM];
                \addplot[fill=QTIM!50] fill between[of=#1_SLIM and #1_QTIM];
                \addplot[fill=Beijing!50] fill between[of=#1_QTIM and #1_Beijing];
                \addplot[fill=AOMIC-PIOP2!50] fill between[of=#1_Beijing and #1_AOMIC-PIOP2];
                \addplot[fill=ds000202!50] fill between[of=#1_AOMIC-PIOP2 and #1_ds000202];
                \addplot[fill=AOMIC-PIOP1!50] fill between[of=#1_ds000202 and #1_AOMIC-PIOP1];
                \addplot[fill=AOMIC-ID1000!50] fill between[of=#1_AOMIC-PIOP1 and #1_AOMIC-ID1000];
                \addplot[fill=CoRR!50] fill between[of=#1_AOMIC-ID1000 and #1_CoRR];
                \addplot[fill=HCP!50] fill between[of=#1_CoRR and #1_HCP];
                \addplot[fill=FCON1000!50] fill between[of=#1_HCP and #1_FCON1000];
                \addplot[fill=NIMH!50] fill between[of=#1_FCON1000 and #1_NIMH];
                \addplot[fill=NKI-RS!50] fill between[of=#1_NIMH and #1_NKI-RS];
                \addplot[fill=MPI-LEMON!50] fill between[of=#1_NKI-RS and #1_MPI-LEMON];
                \addplot[fill=ds003592!50] fill between[of=#1_MPI-LEMON and #1_ds003592];
                \addplot[fill=ds000222!50] fill between[of=#1_ds003592 and #1_ds000222];
                \addplot[fill=SALD!50] fill between[of=#1_ds000222 and #1_SALD];
                \addplot[fill=IXI!50] fill between[of=#1_SALD and #1_IXI];
                \addplot[fill=DLBS!50] fill between[of=#1_IXI and #1_DLBS];
                \addplot[fill=Cam-CAN!50] fill between[of=#1_DLBS and #1_Cam-CAN];
                \addplot[fill=UKBB!50] fill between[of=#1_Cam-CAN and #1_UKBB];
                \addplot[fill=ADNI!50] fill between[of=#1_UKBB and #1_ADNI];
            }

            \node[
                anchor=south east,
                font=\footnotesize
            ] at (axis cs: 99, 0.0){FEMALE};
            \node[
                anchor=north east,
                font=\footnotesize
            ] at (axis cs: 99, -0.0){MALE};

            \def\xdiff{35.5}
            \def\xmin{102}
            \def\ydiff{0.07}
            \def\ymin{12.5*\ydiff}

            \datasetlegendnode{ABCD}{axis cs: \xmin, \ymin}
            \datasetlegendnode{QTAB}{axis cs: \xmin, \ymin-\ydiff}
            \datasetlegendnode{PING}{axis cs: \xmin, \ymin-2*\ydiff}
            \datasetlegendnode{PNC}{axis cs: \xmin, \ymin-3*\ydiff}
            \datasetlegendnode{ds000119}{axis cs: \xmin, \ymin-4*\ydiff}
            \datasetlegendnode{SLIM}{axis cs: \xmin, \ymin-5*\ydiff}
            \datasetlegendnode{QTIM}{axis cs: \xmin, \ymin-6*\ydiff}
            \datasetlegendnode{Beijing}{axis cs: \xmin, \ymin-7*\ydiff}
            \datasetlegendnode{AOMIC-PIOP2}{axis cs: \xmin, \ymin-8*\ydiff}
            \datasetlegendnode{ds000202}{axis cs: \xmin, \ymin-9*\ydiff}
            \datasetlegendnode{AOMIC-PIOP1}{axis cs: \xmin, \ymin-10*\ydiff}
            \datasetlegendnode{AOMIC-ID1000}{axis cs: \xmin, \ymin-11*\ydiff}
            \datasetlegendnode{CoRR}{axis cs: \xmin, \ymin-12*\ydiff}
            \datasetlegendnode{HCP}{axis cs: \xmin, \ymin-13*\ydiff}
            \datasetlegendnode{FCON1000}{axis cs: \xmin, \ymin-14*\ydiff}
            \datasetlegendnode{NIMH}{axis cs: \xmin, \ymin-15*\ydiff}
            \datasetlegendnode{NKI-RS}{axis cs: \xmin, \ymin-16*\ydiff}
            \datasetlegendnode{MPI-LEMON}{axis cs: \xmin, \ymin-17*\ydiff}
            \datasetlegendnode{ds003592}{axis cs: \xmin, \ymin-18*\ydiff}
            \datasetlegendnode{ds000222}{axis cs: \xmin, \ymin-19*\ydiff}
            \datasetlegendnode{SALD}{axis cs: \xmin, \ymin-20*\ydiff}
            \datasetlegendnode{IXI}{axis cs: \xmin, \ymin-21*\ydiff}
            \datasetlegendnode{DLBS}{axis cs: \xmin, \ymin-22*\ydiff}
            \datasetlegendnode{Cam-CAN}{axis cs: \xmin, \ymin-23*\ydiff}
            \datasetlegendnode{UKBB}{axis cs: \xmin, \ymin-24*\ydiff}
            \datasetlegendnode{ADNI}{axis cs: \xmin, \ymin-25*\ydiff}

            \node[align=center, font=\small\linespread{0.9}\selectfont] at (axis cs: 50, -0.6) {
                10,000 MRIs\\10,000 participants\\26 sources
            };
        \end{axis}
    \end{tikzpicture}
}

\newsavebox{\testbox}
\sbox{\testbox}{
    \begin{tikzpicture}
        \begin{axis}[
            width=0.85\textwidth,
            height=0.65\textwidth,
            xmin=0,
            xmax=100,
            ytick=\empty,
            axis x line=middle,
            axis y line=none,
            xtick={10,20,30,40,50,60,70,80,90},
            xticklabels={10,20,30,40,50,60,70,80,{}},
            x axis line style={|-stealth},
            clip=false,
            axis on top,
            tick label style={font=\footnotesize}
        ]
            \pgfplotstableread[col sep=comma]{data/test.csv}\datatable

            \addplot[
                name path=zero,
            ] coordinates {(0,0) (100,0)};

            \pgfplotsinvokeforeach{ds002424, HBN, ADHD200, ABIDE-II, ABIDE-I, BRAINMINT, ds000171, TOP, SCZ-C, ds004302, StrokeMRI, PPMI, Tao-Wu, ds000245, OASIS3, NEUROCON, MIRIAD, AIBL, ADNI}{
                \begingroup
                    \addplot [
                        draw=none,
                        line width=0pt,
                        name path=female_#1,
                    ] table [
                        x=age,
                        y expr=1*\thisrow{female_#1}
                    ] {\datatable};

                    \addplot [
                        draw=none,
                        line width=0pt,
                        name path=male_#1,
                    ] table [
                        x=age,
                        y expr=-1*\thisrow{male_#1}
                    ] {\datatable};
                \endgroup
            }
            \pgfplotsinvokeforeach{male, female}{
                \addplot[fill=ds002424!50] fill between[of=zero and #1_ds002424];
                \addplot[fill=HBN!50] fill between[of=#1_ds002424 and #1_HBN];
                \addplot[fill=ADHD200!50] fill between[of=#1_HBN and #1_ADHD200];
                \addplot[fill=ABIDE-II!50] fill between[of=#1_ADHD200 and #1_ABIDE-II];
                \addplot[fill=ABIDE-I!50] fill between[of=#1_ABIDE-II and #1_ABIDE-I];
                \addplot[fill=BRAINMINT!50] fill between[of=#1_ABIDE-I and #1_BRAINMINT];
                \addplot[fill=ds000171!50] fill between[of=#1_BRAINMINT and #1_ds000171];
                \addplot[fill=TOP!50] fill between[of=#1_ds000171 and #1_TOP];
                \addplot[fill=SCZ-C!50] fill between[of=#1_TOP and #1_SCZ-C];
                \addplot[fill=ds004302!50] fill between[of=#1_SCZ-C and #1_ds004302];
                \addplot[fill=StrokeMRI!50] fill between[of=#1_ds004302 and #1_StrokeMRI];
                \addplot[fill=PPMI!50] fill between[of=#1_StrokeMRI and #1_PPMI];
                \addplot[fill=Tao-Wu!50] fill between[of=#1_PPMI and #1_Tao-Wu];
                \addplot[fill=ds000245!50] fill between[of=#1_Tao-Wu and #1_ds000245];
                \addplot[fill=OASIS3!50] fill between[of=#1_ds000245 and #1_OASIS3];
                \addplot[fill=NEUROCON!50] fill between[of=#1_OASIS3 and #1_NEUROCON];
                \addplot[fill=MIRIAD!50] fill between[of=#1_NEUROCON and #1_MIRIAD];
                \addplot[fill=AIBL!50] fill between[of=#1_MIRIAD and #1_AIBL];
                \addplot[fill=ADNI!50] fill between[of=#1_AIBL and #1_ADNI];
            }

            \node[
                anchor=south east
            ] at (axis cs: 99, 0.0){FEMALE};
            \node[
                anchor=north east
            ] at (axis cs: 99, -0.0){MALE};

            \def\ydiff{0.07}
            \def\ymin{9*\ydiff}
            \def\xmin{102}

            \datasetlegendnode{ds002424}{axis cs: \xmin, \ymin}
            \datasetlegendnode{HBN}{axis cs: \xmin, \ymin-\ydiff}
            \datasetlegendnode{ADHD200}{axis cs: \xmin, \ymin-2*\ydiff}
            \datasetlegendnode{ABIDE-II}{axis cs: \xmin, \ymin-3*\ydiff}
            \datasetlegendnode{ABIDE-I}{axis cs: \xmin, \ymin-4*\ydiff}
            \datasetlegendnode{BRAINMINT}{axis cs: \xmin, \ymin-5*\ydiff}
            \datasetlegendnode{ds000171}{axis cs: \xmin, \ymin-6*\ydiff}
            \datasetlegendnode{TOP}{axis cs: \xmin, \ymin-7*\ydiff}
            \datasetlegendnode{SCZ-C}{axis cs: \xmin, \ymin-8*\ydiff}
            \datasetlegendnode{ds004302}{axis cs: \xmin, \ymin-9*\ydiff}
            \datasetlegendnode{StrokeMRI}{axis cs: \xmin, \ymin-10*\ydiff}
            \datasetlegendnode{PPMI}{axis cs: \xmin, \ymin-11*\ydiff}
            \datasetlegendnode{Tao-Wu}{axis cs: \xmin, \ymin-12*\ydiff}
            \datasetlegendnode{ds000245}{axis cs: \xmin, \ymin-13*\ydiff}
            \datasetlegendnode{OASIS3}{axis cs: \xmin, \ymin-14*\ydiff}
            \datasetlegendnode{NEUROCON}{axis cs: \xmin, \ymin-15*\ydiff}
            \datasetlegendnode{MIRIAD}{axis cs: \xmin, \ymin-16*\ydiff}
            \datasetlegendnode{AIBL}{axis cs: \xmin, \ymin-17*\ydiff}
            \datasetlegendnode{ADNI}{axis cs: \xmin, \ymin-18*\ydiff}
            \node[align=center, font=\small\linespread{0.9}\selectfont] at (axis cs: 50, -0.6) {
                34,250 MRIs\\13,442 participants\\19 sources
            };
        \end{axis}
    \end{tikzpicture}
}

\newcommand{\predictionstrace}[3]{
    \addplot[
        only marks,
        scatter,
        scatter src=explicit,
        mark size=2pt,
        opacity=0.1,
    ] table [
        col sep=comma,
        x=true,
        y=predicted,
        meta=density
    ] {data/predictions/#1_#2_#3.csv};
}

\newsavebox{\validationpredictions}
\sbox{\validationpredictions}{
    \begin{tikzpicture}
        \begin{groupplot}[
            group style={
                group size=3 by 2,
                horizontal sep=0.5cm,
                vertical sep=0.5cm
            },
            height=4cm,
            width=4cm,
            xtick pos=bottom,
            ytick pos=left,
            tick style={draw=none},
            xticklabels=\empty,
            yticklabels=\empty,
            scaled ticks=false,
            title style={
                text depth=0,
                yshift=-0.25cm,
                font=\footnotesize
            }
        ]
            \nextgroupplot[
                title=Age
            ];
                \draw[] (rel axis cs: 0,0) -- (rel axis cs: 1, 1);
                \predictionstrace{multi}{val}{age}
                \node[font=\scriptsize, anchor=south east] at (rel axis cs: 1, 0) {
                    MAE=$2.23$
                };

            \nextgroupplot[
                title=Sex
            ];
                \predictionstrace{multi}{val}{sex}
                \node[font=\scriptsize, anchor=south] at (rel axis cs: 0.5, 0) {
                    AUC=$0.99$
                };

           \nextgroupplot[
                title=Handedness
           ];
                \predictionstrace{multi}{val}{handedness}
                \node[font=\scriptsize, anchor=south] at (rel axis cs: 0.5, 0) {
                    AUC=$0.61$
                };

            \nextgroupplot[
                title=BMI
            ];
                \draw[] (rel axis cs: 0,0) -- (rel axis cs: 1, 1);
                \predictionstrace{multi}{val}{bmi}
                \node[font=\scriptsize, anchor=south east] at (rel axis cs: 1, 0) {
                    MAE=$2.38$
                };

            \nextgroupplot[
                title=Fluid intelligence
            ];
                \draw[] (rel axis cs: 0,0) -- (rel axis cs: 1, 1);
                \predictionstrace{multi}{val}{fluid_intelligence}
                \node[font=\scriptsize, anchor=south east] at (rel axis cs: 1, 0) {
                    R=$0.26$
                };

            \nextgroupplot[
                title=Neuroticism
            ];
                \draw[] (rel axis cs: 0,0) -- (rel axis cs: 1, 1);
                \predictionstrace{multi}{val}{neuroticism}
                \node[font=\scriptsize, anchor=south east] at (rel axis cs: 1, 0) {
                    R=$0.16$
                };
        \end{groupplot}
        \node[anchor=north, font=\footnotesize\bfseries] at ($ (group c2r2.south) + (0, -0.2) $) {Observed};
        \node[anchor=south, font=\footnotesize\bfseries, rotate=90] at ($ (group c1r1.west)!0.5!(group c1r2.west) + (-0.2, 0) $) {Predicted};
    \end{tikzpicture}
}

\newsavebox{\testpredictions}
\sbox{\testpredictions}{
    \begin{tikzpicture}
        \begin{groupplot}[
            group style={
                group size=2 by 1,
                horizontal sep=0.5cm,
                vertical sep=0.5cm
            },
            height=6.25cm,
            width=6.25cm,
            xtick pos=bottom,
            ytick pos=left,
            scaled ticks=false,
            xmin=0,
            xmax=100,
            ymin=0,
            ymax=100,
            tick style={
                draw=none
            },
            ymajorgrids=true,
            xmajorgrids=true,
            xlabel=Observed,
            title style={
                text depth=0,
                font=\bfseries
            }
        ]
            \nextgroupplot[
                ylabel=Predicted,
                title={Brain age model}
            ]
                \draw[] (rel axis cs: 0,0) -- (rel axis cs: 1, 1);
                \predictionstrace{reg}{test}{age}
                \node[anchor=south east, text=red] at (rel axis cs: 1, 0) {
                    MAE=$3.60$
                };

            \nextgroupplot[
                title={Multitask model},
                yticklabels=\empty
            ]
                \draw[] (rel axis cs: 0,0) -- (rel axis cs: 1, 1);
                \predictionstrace{multi}{test}{age}
                \node[anchor=south east, text=red] at (rel axis cs: 1, 0) {
                    MAE=$3.35$
                };
        \end{groupplot}
    \end{tikzpicture}
}

\begin{frame}{Results: Validation}
    \begin{tikzpicture}
        \node[] at (-7, -3.25) {};
        \node[] at (7, 3.25) {};

        \only<1>{
            \node[] at (0, 0) {
                \usebox{\validationbox}
            };
        }

        \only<2>{
            \node[] at (0, 0) {
                \usebox{\validationpredictions}
            };
        }
    \end{tikzpicture}
\end{frame}
\begin{frame}{Results: Brain age}
    \begin{tikzpicture}
        \node[] at (-7, -3.25) {};
        \node[] at (7, 3.25) {};

        \only<1>{
            \node[] at (0, 0) {
                \usebox{\testbox}
            };
        }
        \only<2>{
            \node[] at (0, 0) {
                \usebox{\testpredictions}
            };
        }

    \end{tikzpicture}
\end{frame}

\newcommand{\heatmap}[4][]{
    \nextgroupplot[
        view={0}{90},
        colormap/temp,
        ymin=0,
        xmin=0,
        xmajorticks=false,
        ymajorticks=false,
        point meta min=-1,
        point meta max=1,
        #1,
        title=#3,
        title style={
            text depth=0,
            font=\bfseries,
            yshift=-0.2cm
        }
    ]
        \addplot3 [
            surf,
            shader=flat corner,
            mesh/rows=#4,
            mesh/cols=64
        ] table [
            col sep=comma,
            x=x,
            y=y,
            z=value,
        ] {#2};
}

\newcommand{\heatmaps}{
    \begin{tikzpicture}
        \begin{groupplot}[
            group style={
                group size=2 by 1,
                horizontal sep=0.3cm
            },
            height=6cm,
            width=6cm
        ]
            \heatmap[
                ylabel={Features},
                xlabel=Features,
                title={Brain age model}
            ]{data/encodings/sfcn-reg.csv}{}{64}
            \heatmap[
                xlabel=Features,
                colormap/temp,
                colorbar,
                colorbar style={
                    xshift=0.2cm,
                    tick style={draw=none},
                    ticklabel style={font=\scriptsize},
                    ytick={-1, 0, 1},
                    yticklabels={\textbf{-1}, \textbf{0}, \textbf{1}}
                },
                title={Multitask model}
            ]{data/encodings/sfcn-multi.csv}{}{64}

        \end{groupplot}
        \node[font=\scriptsize\bfseries, rotate=90] at ($ (group c2r1.east) + (1.6, 0) $){Correlation};
    \end{tikzpicture}
}

\newcommand{\volumes}{
    \begin{tikzpicture}
        \begin{groupplot}[
            group style={
                group size=2 by 1,
                horizontal sep=0.3cm
            },
            height=6cm,
            width=6cm
        ]
            \heatmap[
                ylabel={Regional volumes},
                xlabel=Features,
                title={Brain age model}
            ]{data/correlations/sfcn-reg.csv}{}{96}
            \heatmap[
                xlabel=Features,
                colormap/temp,
                colorbar,
                colorbar style={
                    xshift=0.2cm,
                    tick style={draw=none},
                    ticklabel style={font=\scriptsize},
                    ytick={-1, 0, 1},
                    yticklabels={\textbf{-1}, \textbf{0}, \textbf{1}}
                },
                title={Multitask model}
            ]{data/correlations/sfcn-multi.csv}{}{96}

        \end{groupplot}
        \node[font=\scriptsize\bfseries, rotate=90] at ($ (group c2r1.east) + (1.6, 0) $){Correlation};
    \end{tikzpicture}
}

\begin{frame}{Results: Feature spaces}
    \begin{tikzpicture}
        \node[] at (-7, -3.25) {};
        \node[] at (7, 3.25) {};

        \only<1>{
            \node[] at (0, 0) {
                \heatmaps
            };
        }
        \only<2>{
            \node[] at (0, 0) {
                \volumes
            };
        }
    \end{tikzpicture}
\end{frame}